<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-R" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trình chỉnh sửa JSON Câu hỏi (v4 - Đã sửa lỗi)</title>
    <style>
        :root {
            --color-primary: #0056b3;
            --color-light-bg: #f4f7f6;
            --color-border: #dcdcdc;
            --color-correct: #28a745;
            --color-incorrect: #dc3545;
            --color-text: #333;
            --color-tab-active: #fff;
            --color-sidebar-bg: #f8f9fa;
            --color-main-bg: #ffffff;
            --shadow-light: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        html, body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            background-color: var(--color-light-bg);
            color: var(--color-text);
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }
        
        body {
            display: flex;
            flex-direction: column;
        }

        header {
            padding: 20px;
            background: var(--color-main-bg);
            border-bottom: 2px solid var(--color-primary);
            flex-shrink: 0;
            text-align: center;
        }

        h1 {
            color: var(--color-primary);
            margin: 0;
        }

        #quiz-ui {
            display: flex;
            flex-grow: 1;
            min-height: 0;
        }

        /* --- Sidebar & Tabs --- */
        #left-sidebar {
            width: 280px; 
            flex-shrink: 0;
            background-color: var(--color-sidebar-bg);
            border-right: 1px solid var(--color-border);
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        #left-sidebar h2 {
            margin: 0 0 10px 0;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--color-border);
            color: var(--color-primary);
            font-size: 1.2em;
        }

        #tab-nav {
            border: 1px solid var(--color-border);
            border-radius: 5px;
            background: var(--color-main-bg);
            max-height: 40vh;
            overflow-y: auto;
        }
        
        .tab-button {
            display: block;
            width: 100%;
            padding: 12px 18px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 16px;
            font-weight: 500;
            text-align: left;
            transition: background-color 0.3s, color 0.3s;
            border-bottom: 1px solid var(--color-border);
        }
        .tab-button:last-child { border-bottom: none; }
        .tab-button:hover { background-color: #e9ecef; }
        .tab-button.active {
            background-color: var(--color-primary);
            color: var(--color-tab-active);
        }

        .toolbar-group {
            border: 1px solid var(--color-border);
            padding: 15px;
            border-radius: 5px;
            background: var(--color-main-bg);
            margin-top: 20px;
        }
        .toolbar-group label {
            font-weight: 600;
            display: block;
            margin-bottom: 10px;
        }
        
        #file-name {
            display: block;
            margin-top: 10px;
            font-style: italic;
            color: #555;
            font-size: 0.9em;
            word-break: break-all;
        }

        /* --- Main Content & Panes --- */
        #main-content {
            flex-grow: 1;
            overflow-y: auto;
            background-color: var(--color-main-bg);
        }
        
        .tab-pane {
            display: none;
            padding: 25px;
        }
        .tab-pane.active {
            display: block;
        }

        /* --- Button Styles --- */
        .btn {
            display: inline-block;
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 15px;
            font-weight: bold;
            text-align: center;
            text-decoration: none;
            transition: opacity 0.3s;
            box-sizing: border-box;
        }
        .btn-primary { background: var(--color-primary); color: white; }
        .btn-primary:hover { opacity: 0.8; }
        .btn-success { background: var(--color-correct); color: white; }
        .btn-success:hover { opacity: 0.8; }
        .btn-danger {
            background-color: var(--color-incorrect);
            color: white;
            padding: 5px 10px;
            font-size: 14px;
            width: auto;
            min-width: 30px;
            line-height: 1.2;
        }
        .btn-danger:hover { opacity: 0.8; }
        .btn-add {
            background-color: #007bff;
            color: white;
            padding: 6px 12px;
            font-size: 14px;
            width: auto;
            margin-top: 10px;
        }
        .btn-add:hover { background-color: #0056b3; }

        #uploadInput { display: none; }

        /* --- Editor Card Styles --- */
        .question-card {
            border: 1px solid var(--color-border);
            border-radius: 8px;
            margin-bottom: 20px;
            background: #fff;
            box-shadow: var(--shadow-light);
            /* overflow: hidden;  <-- ĐÃ XÓA DÒNG NÀY ĐỂ SỬA LỖI DROPDOWN */
        }
        
        .question-header {
            padding: 15px 20px;
            background: #fdfdfd;
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .question-header .q-id {
            font-weight: bold;
            color: var(--color-primary);
            font-family: monospace;
            font-size: 1.1em;
        }
        .question-header .q-type-select {
            font-family: monospace;
            background-color: #e0e0e0;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 3px 8px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
        }

        .question-content {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 14px;
        }
        .form-group input[type="text"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
            font-family: inherit;
        }
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        /* --- Editor Item Styles --- */
        .option-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .option-item input[type="radio"],
        .option-item input[type="checkbox"] {
            flex-shrink: 0;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .option-item input[type="text"] { flex-grow: 1; }
        .option-item .delete-btn { flex-shrink: 0; }
        
        /* Drag Drop Editor */
        .drag-drop-editor {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-top: 20px;
        }
        .list-group {
            border: 1px solid var(--color-border);
            border-radius: 5px;
            padding: 15px;
        }
        .list-group h4 {
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .answer-mapping {
            grid-column: 1 / -1;
            margin-top: 10px;
        }
        .answer-mapping h4 { margin-top: 0; margin-bottom: 15px; }
        .mapping-item {
            display: grid;
            grid-template-columns: 1fr auto 1.5fr auto; 
            gap: 10px 15px;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
        }
        .mapping-item .zone-text {
            font-weight: 600;
            text-align: right;
        }
        .dd-multi-check { 
            display: flex;
            align-items: center;
            white-space: nowrap;
            font-size: 0.9em;
            cursor: pointer;
        }
        .dd-multi-check input {
            margin-right: 5px;
            cursor: pointer;
        }
        .dd-multi-check label {
             font-weight: normal;
             margin-bottom: 0;
             cursor: pointer;
        }
        
        /* CUSTOM MULTI-SELECT DROPDOWN STYLES (MỚI) */
        .custom-multi-select {
            position: relative;
            width: 100%;
        }

        .select-box {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            background-color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 40px;
            box-sizing: border-box;
        }
        
        .select-box:after {
            content: '▼';
            font-size: 10px;
            color: #888;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: white;
            z-index: 10;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .dropdown-menu.visible {
            display: block;
        }

        .dropdown-item {
            padding: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dropdown-item:hover {
            background-color: #f0f0f0;
        }
        
        .dropdown-item input[type="checkbox"] {
            margin: 0;
        }
        
        .selected-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }
        
        .tag {
            background-color: var(--color-primary);
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            white-space: nowrap;
        }
        .tag-single {
             background-color: #5cb85c;
             color: white;
             padding: 4px 8px;
             border-radius: 3px;
             font-size: 14px;
             white-space: nowrap;
        }


        /* True/False Editor */
         .tf-option-item {
            display: grid;
            grid-template-columns: 1fr auto auto; 
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        .tf-option-item select { width: 120px; }
        
        @media (max-width: 768px) {
            #quiz-ui {
                flex-direction: column;
            }
            #left-sidebar {
                width: 100%;
                height: auto;
                flex-shrink: 1;
                border-right: none;
                border-bottom: 1px solid var(--color-border);
                box-sizing: border-box;
            }
            #tab-nav {
                max-height: 25vh;
            }
            #main-content {
                padding: 15px;
            }
            .tab-pane { padding: 15px; }
            .drag-drop-editor {
                grid-template-columns: 1fr;
            }
             .mapping-item {
                 grid-template-columns: 1fr;
                 gap: 8px;
             }
             .mapping-item .zone-text {
                 text-align: left;
             }
        }
        /* --- Mở rộng vùng "Thiết lập đáp án" --- */
.answer-mapping {
  grid-column: 1 / -1; /* giữ nguyên chiếm hết 2 cột */
  width: 100%;
  max-width: none; /* bỏ giới hạn độ rộng */
  background: #f9fafc;
  padding: 20px 25px;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

/* --- Làm mỗi dòng đáp án rộng ra và không bị bó --- */
.mapping-item {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}

.mapping-item .zone-text {
  min-width: 180px;
  font-weight: 600;
  text-align: left;
}

.mapping-item .custom-multi-select {
  flex: 1;
  min-width: 400px; /* phần chọn rộng hơn */
}

.dd-multi-check {
  margin-left: auto;
}
.drag-drop-editor {
  grid-template-columns: 1fr; /* chỉ 1 cột lớn thay vì chia đôi */
}

    </style>
</head>
<body>

    <header>
        <h1>Trình chỉnh sửa JSON Trắc nghiệm (v4)</h1>
    </header>

    <div id="quiz-ui">
        <aside id="left-sidebar">
            <h2>Chủ đề</h2>
            <nav id="tab-nav">
                </nav>
            
            <div class="toolbar-group">
                <label for="uploadInput" class="btn btn-primary">Tải lên tệp JSON</label>
                <input type="file" id="uploadInput" accept="application/json" />
                <span id="file-name">Chưa chọn tệp...</span>
            </div>
            
             <div class="toolbar-group">
                <label for="downloadButton">Tải xuống tệp đã sửa</label>
                <button id="downloadButton" class="btn btn-success">Tải JSON đã sửa</button>
            </div>
        </aside>

        <main id="main-content">
            <div id="tab-content">
                <p style="padding: 25px;">Vui lòng tải lên một tệp JSON bằng thanh công cụ bên trái để bắt đầu.</p>
            </div>
        </main>
    </div>

    <script>
        let originalData = null;
        let originalFileName = 'questions.json';
        let flatQuestionRefs = []; 
        
        const uploadInput = document.getElementById('uploadInput');
        const downloadButton = document.getElementById('downloadButton');
        const tabNav = document.getElementById('tab-nav');
        const tabContent = document.getElementById('tab-content');
        const fileNameSpan = document.getElementById('file-name');

        // 1. XỬ LÝ TẢI LÊN
        uploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            originalFileName = file.name;
            fileNameSpan.textContent = file.name;
            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    originalData = JSON.parse(e.target.result);
                    renderEditor(originalData);
                } catch (error) {
                    alert('Lỗi: Tệp JSON không hợp lệ!\n' + error.message);
                }
            };
            
            reader.readAsText(file);
        });

        // 2. XỬ LÝ TẢI XUỐNG
        downloadButton.addEventListener('click', () => {
            if (!originalData) {
                alert('Không có dữ liệu để tải xuống. Hãy tải lên một tệp trước.');
                return;
            }
            
            const dataStr = JSON.stringify(originalData, null, 4);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `edited_${originalFileName}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // 3. HÀM RENDER CHÍNH 
        function renderEditor(data) {
            tabNav.innerHTML = '';
            tabContent.innerHTML = '';
            flatQuestionRefs = [];

            if (!data) {
                tabContent.innerHTML = '<p style="padding: 25px;">Dữ liệu JSON trống.</p>';
                return;
            }
            
            let hasSubjects = false;

            // Cấu trúc 3: Object chứa 'subjects'
            if (data.subjects && Array.isArray(data.subjects)) {
                hasSubjects = true;
                data.subjects.forEach((subject, subjectIndex) => {
                    const tabButton = createTabButton(subject.title || `Chủ đề ${subjectIndex + 1}`, subjectIndex);
                    tabNav.appendChild(tabButton);
                    
                    const pane = createTabPane(subjectIndex);
                    
                    subject.questions.forEach((q) => {
                        const qIndex = flatQuestionRefs.length;
                        flatQuestionRefs.push(q);
                        pane.appendChild(createQuestionCard(q, qIndex));
                    });
                    
                    pane.appendChild(createAddQuestionButton(subjectIndex)); 
                    tabContent.appendChild(pane);
                });
            } 
            // Cấu trúc 1 & 2: Mảng phẳng hoặc { questions: [...] }
            else {
                let questions = [];
                if (Array.isArray(data)) {
                    questions = data;
                } else if (data.questions && Array.isArray(data.questions)) {
                    questions = data.questions;
                }
                
                if (questions.length > 0) {
                    const subjectIndex = 0;
                    const tabButton = createTabButton('Chủ đề mặc định', subjectIndex);
                    tabNav.appendChild(tabButton);

                    const pane = createTabPane(subjectIndex);
                    
                    questions.forEach((q) => {
                        const qIndex = flatQuestionRefs.length;
                        flatQuestionRefs.push(q);
                        pane.appendChild(createQuestionCard(q, qIndex));
                    });
                    
                    pane.appendChild(createAddQuestionButton(subjectIndex)); 
                    tabContent.appendChild(pane);
                    hasSubjects = true;
                }
            }
            
            if (!hasSubjects) {
                 tabContent.innerHTML = '<p style="padding: 25px;">Không nhận diện được cấu trúc tệp JSON.</p>';
                 return;
            }

            // Kích hoạt tab đầu tiên
            if (tabNav.children.length > 0) {
                tabNav.children[0].classList.add('active');
                tabContent.children[0].classList.add('active');
            }
            
            tabNav.removeEventListener('click', handleTabClick);
            tabNav.addEventListener('click', handleTabClick);
            
            // Đóng dropdown khi click ra ngoài
            document.addEventListener('click', (e) => {
                document.querySelectorAll('.dropdown-menu').forEach(menu => {
                    if (!menu.closest('.custom-multi-select').contains(e.target)) {
                        menu.classList.remove('visible');
                    }
                });
            });
        }
        
        // 4. CÁC HÀM TRỢ GIÚP RENDER
        
        function createTabButton(text, index) {
            const tabButton = document.createElement('button');
            tabButton.className = 'tab-button';
            tabButton.textContent = text;
            tabButton.dataset.target = `pane-${index}`;
            return tabButton;
        }
        
        function createTabPane(index) {
            const pane = document.createElement('div');
            pane.className = 'tab-pane';
            pane.id = `pane-${index}`;
            return pane;
        }

        function handleTabClick(event) {
            const target = event.target.closest('.tab-button');
            if (!target) return;

            const targetPaneId = target.dataset.target;

            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.toggle('active', btn === target);
            });

            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.toggle('active', pane.id === targetPaneId);
            });
        }
        
        function createAddQuestionButton(subjectIndex) {
            const button = document.createElement('button');
            button.className = 'btn btn-primary';
            button.textContent = '+ Thêm câu hỏi mới';
            button.style.marginTop = '20px';
            button.onclick = () => addNewQuestion(subjectIndex);
            return button;
        }
        
        // 5. TẠO CARD CÂU HỎI
        function createQuestionCard(question, qIndex) {
            const card = document.createElement('div');
            card.className = 'question-card';
            card.id = `card-${qIndex}`; 
            
            const header = document.createElement('div');
            header.className = 'question-header';
            
            const idSpan = document.createElement('span');
            idSpan.className = 'q-id';
            idSpan.textContent = `ID: ${question.id}`;
            header.appendChild(idSpan);
            
            const typeSelect = document.createElement('select');
            typeSelect.className = 'q-type-select';
            const types = ['single_choice', 'multiple_choice', 'true_false', 'fill_blank', 'drag_drop'];
            types.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t;
                opt.textContent = t;
                if (t === question.type) opt.selected = true;
                typeSelect.appendChild(opt);
            });
            typeSelect.onchange = (e) => changeQuestionType(qIndex, e.target.value);
            header.appendChild(typeSelect);
            
            card.appendChild(header);
            
            const content = document.createElement('div');
            content.className = 'question-content';
            content.appendChild(createTextField(qIndex, 'text', 'Nội dung câu hỏi', question.text, true));
            
            switch (question.type) {
                case 'single_choice':
                case 'multiple_choice':
                    content.appendChild(createChoiceEditor(question, qIndex));
                    break;
                case 'fill_blank':
                    content.appendChild(createFillBlankEditor(question, qIndex));
                    break;
                case 'true_false':
                    content.appendChild(createTrueFalseEditor(question, qIndex));
                    break;
                case 'drag_drop':
                    content.appendChild(createDragDropEditor(question, qIndex));
                    break;
            }
            
            card.appendChild(content);
            return card;
        }

        // --- Hàm tạo Custom Multi-Select Dropdown (MỚI) ---
        function createCustomMultiSelect(qIndex, zoneText, options, currentAnswers, isMultiple) {
            const container = document.createElement('div');
            container.className = 'custom-multi-select';

            const selectBox = document.createElement('div');
            selectBox.className = 'select-box';
            
            const selectedTagsContainer = document.createElement('div');
            selectedTagsContainer.className = 'selected-tags-container';
            selectBox.appendChild(selectedTagsContainer);

            const dropdownMenu = document.createElement('div');
            dropdownMenu.className = 'dropdown-menu';

            // Hàm cập nhật hiển thị tags
            const updateTags = (answers) => {
                selectedTagsContainer.innerHTML = '';
                
                if (isMultiple) {
                    if (Array.isArray(answers) && answers.length > 0) {
                        answers.forEach(val => {
                            const optionIndex = val - 1;
                            const optionText = options[optionIndex] ? options[optionIndex] : `[Option ${val}]`;
                            const tag = document.createElement('span');
                            tag.className = 'tag';
                            tag.textContent = optionText;
                            selectedTagsContainer.appendChild(tag);
                        });
                    } else {
                        selectedTagsContainer.textContent = '(Chưa chọn)';
                    }
                } else {
                    if (answers !== null && answers !== undefined) {
                        const optionIndex = answers - 1;
                        const optionText = options[optionIndex] ? options[optionIndex] : `[Option ${answers}]`;
                        const tag = document.createElement('span');
                        tag.className = 'tag-single';
                        tag.textContent = optionText;
                        selectedTagsContainer.appendChild(tag);
                    } else {
                        selectedTagsContainer.textContent = '(Chưa chọn)';
                    }
                }
            };

            // Tạo các item trong dropdown
            options.forEach((optionText, oIndex) => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                
                const optionValue = oIndex + 1;

                // Nếu là Chọn Nhiều -> Checkbox
                if (isMultiple) {
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = Array.isArray(currentAnswers) && currentAnswers.includes(optionValue);
                    checkbox.value = optionValue;
                    
                    // === BẢN VÁ JAVASCRIPT 1 ===
                    checkbox.onchange = (e) => {
                        // LỖI ĐƯỢC SỬA: Luôn đọc dữ liệu mới nhất từ flatQuestionRefs
                        const currentQuestion = flatQuestionRefs[qIndex];
                        const sourceAnswers = currentQuestion.answers[zoneText];

                        let newAnswers = Array.isArray(sourceAnswers) ? [...sourceAnswers] : [];
                        
                        if (e.target.checked) {
                            if (!newAnswers.includes(optionValue)) newAnswers.push(optionValue);
                        } else {
                            newAnswers = newAnswers.filter(val => val !== optionValue);
                        }
                        
                        newAnswers.sort((a, b) => a - b);
                        updateDDAnswer(qIndex, zoneText, newAnswers);
                        updateTags(newAnswers); // Hàm này bây giờ sẽ cập nhật thẻ tag ngay lập tức
                        // Không đóng menu khi chọn/bỏ chọn
                    };
                    // === KẾT THÚC BẢN VÁ 1 ===
                    
                    item.appendChild(checkbox);
                } 
                // Nếu là Chọn Một -> Radio-like behavior
                else {
                    
                    // === BẢN VÁ JAVASCRIPT 2 ===
                    item.onclick = (e) => {
                        // LỖI ĐƯỢC SỬA: Đọc dữ liệu mới nhất từ flatQuestionRefs
                        const currentQuestion = flatQuestionRefs[qIndex];
                        const sourceAnswer = currentQuestion.answers[zoneText];

                        const newAnswer = (sourceAnswer === optionValue) ? null : optionValue;
                        updateDDAnswer(qIndex, zoneText, newAnswer);
                        
                        // Không cần gọi updateTags() vì rerenderQuestionCard() sẽ làm điều đó
                        
                        // Đóng menu và rerender để cập nhật các item khác
                        dropdownMenu.classList.remove('visible');
                        rerenderQuestionCard(qIndex); // Rerender sẽ cập nhật mọi thứ
                    };
                    // === KẾT THÚC BẢN VÁ 2 ===
                }
                
                const textSpan = document.createElement('span');
                textSpan.textContent = `(${optionValue}) ${optionText}`;
                item.appendChild(textSpan);
                dropdownMenu.appendChild(item);
            });
            
            // Thêm tùy chọn "Xóa hết/Không chọn" cho chế độ Chọn Một
             if (!isMultiple) {
                 const clearItem = document.createElement('div');
                 clearItem.className = 'dropdown-item';
                 clearItem.innerHTML = '<em>(Xóa đáp án đã chọn)</em>';
                 clearItem.onclick = () => {
                     updateDDAnswer(qIndex, zoneText, null);
                     updateTags(null);
                     dropdownMenu.classList.remove('visible');
                     rerenderQuestionCard(qIndex);
                 };
                 dropdownMenu.prepend(clearItem);
             }


            selectBox.onclick = (e) => {
                e.stopPropagation(); // Ngăn sự kiện click nổi bọt lên document
                document.querySelectorAll('.dropdown-menu').forEach(menu => {
                    if (menu !== dropdownMenu) {
                        menu.classList.remove('visible');
                    }
                });
                dropdownMenu.classList.toggle('visible');
            };

            container.appendChild(selectBox);
            container.appendChild(dropdownMenu);
            
            // Khởi tạo hiển thị tags
            updateTags(currentAnswers);
            
            return container;
        }
        // --- End Custom Multi-Select Dropdown ---

        // (Các hàm createTextField, createChoiceEditor, createFillBlankEditor, createTrueFalseEditor không thay đổi)
        function createTextField(qIndex, key, label, value, isTextarea = false) {
            const group = document.createElement('div');
            group.className = 'form-group';
            const labelEl = document.createElement('label');
            labelEl.textContent = label;
            let inputEl;
            if (isTextarea) {
                inputEl = document.createElement('textarea');
                inputEl.textContent = value;
            } else {
                inputEl = document.createElement('input');
                inputEl.type = 'text';
                inputEl.value = value;
            }
            inputEl.onchange = (e) => updateField(qIndex, key, e.target.value);
            group.appendChild(labelEl);
            group.appendChild(inputEl);
            return group;
        }

        function createChoiceEditor(question, qIndex) {
            const group = document.createElement('div');
            group.className = 'form-group';
            const label = document.createElement('label');
            label.textContent = 'Các tùy chọn (Chọn đáp án đúng)';
            group.appendChild(label);

            const type = question.type === 'single_choice' ? 'radio' : 'checkbox';
            
            (question.options || []).forEach((option, oIndex) => {
                const item = document.createElement('div');
                item.className = 'option-item';
                
                const inputCheck = document.createElement('input');
                inputCheck.type = type;
                inputCheck.name = `answer_${qIndex}`;
                
                if (type === 'radio') {
                    inputCheck.checked = (question.answers === (oIndex + 1));
                } else {
                    inputCheck.checked = Array.isArray(question.answers) && question.answers.includes(oIndex + 1);
                }
                inputCheck.onchange = () => updateChoiceAnswer(qIndex, oIndex);
                
                const inputText = document.createElement('input');
                inputText.type = 'text';
                inputText.value = option;
                inputText.onchange = (e) => updateOptionText(qIndex, oIndex, e.target.value);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger delete-btn';
                deleteBtn.textContent = 'X';
                deleteBtn.onclick = () => deleteOption(qIndex, oIndex);
                
                item.appendChild(inputCheck);
                item.appendChild(inputText);
                item.appendChild(deleteBtn);
                group.appendChild(item);
            });

            const addBtn = document.createElement('button');
            addBtn.className = 'btn btn-add';
            addBtn.textContent = 'Thêm tùy chọn';
            addBtn.onclick = () => addOption(qIndex);
            group.appendChild(addBtn);
            
            return group;
        }

        function createFillBlankEditor(question, qIndex) {
             return createTextField(qIndex, 'answers', 'Đáp án', question.answers);
        }
        
        function createTrueFalseEditor(question, qIndex) {
            const group = document.createElement('div');
            group.className = 'form-group';
            const label = document.createElement('label');
            label.textContent = 'Các mệnh đề';
            group.appendChild(label);
            
            (question.options || []).forEach((option, oIndex) => {
                const item = document.createElement('div');
                item.className = 'tf-option-item';
                const answerKey = (oIndex + 1).toString();
                
                const inputText = document.createElement('input');
                inputText.type = 'text';
                inputText.value = option;
                inputText.onchange = (e) => updateOptionText(qIndex, oIndex, e.target.value);
                
                const select = document.createElement('select');
                ['Đúng', 'Sai'].forEach(val => {
                    const opt = document.createElement('option');
                    opt.value = val;
                    opt.textContent = val;
                    if (question.answers[answerKey] === val) opt.selected = true;
                    select.appendChild(opt);
                });
                select.onchange = (e) => updateTFAnswer(qIndex, answerKey, e.target.value);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger delete-btn';
                deleteBtn.textContent = 'X';
                deleteBtn.onclick = () => deleteTFOption(qIndex, oIndex);

                item.appendChild(inputText);
                item.appendChild(select);
                item.appendChild(deleteBtn);
                group.appendChild(item);
            });

            const addBtn = document.createElement('button');
            addBtn.className = 'btn btn-add';
            addBtn.textContent = 'Thêm mệnh đề';
            addBtn.onclick = () => addTFOption(qIndex);
            group.appendChild(addBtn);
            
            return group;
        }

        function createDragDropEditor(question, qIndex) {
            const container = document.createElement('div');
            container.className = 'drag-drop-editor';
            
            container.appendChild(createListEditor(qIndex, 'Tùy chọn kéo (Options)', question.options, updateDDOption, deleteDDOption, addDDOption));
            container.appendChild(createListEditor(qIndex, 'Vùng thả (Drop Zones)', question.drop_zones, updateDDZone, deleteDDZone, addDDZone));
            
            const answerMapping = document.createElement('div');
            answerMapping.className = 'answer-mapping list-group';
            answerMapping.innerHTML = '<h4>Thiết lập đáp án</h4>';
            
            (question.drop_zones || []).forEach((zone) => {
                const item = document.createElement('div');
                item.className = 'mapping-item';
                
                const zoneText = document.createElement('span');
                zoneText.className = 'zone-text';
                zoneText.textContent = zone;
                
                item.appendChild(zoneText);
                item.appendChild(document.createTextNode('→'));
                
                let currentAnswer = question.answers[zone];
                let isMultiple = Array.isArray(currentAnswer);

                // --- Thay thế select bằng Custom Multi-Select ---
                const customSelect = createCustomMultiSelect(qIndex, zone, question.options || [], currentAnswer, isMultiple);
                item.appendChild(customSelect);
                // ----------------------------------------------
                
                // Checkbox "Chọn nhiều"
                const multiCheckDiv = document.createElement('div');
                multiCheckDiv.className = 'dd-multi-check';
                const check = document.createElement('input');
                check.type = 'checkbox';
                const checkId = `multi_${qIndex}_${zone.replace(/[^a-z0-9]/gi, '_')}`;
                check.id = checkId;
                check.checked = isMultiple;
                check.onchange = (e) => toggleDDMulti(qIndex, zone, e.target.checked);
                
                const checkLabel = document.createElement('label');
                checkLabel.htmlFor = checkId;
                checkLabel.textContent = 'Chọn nhiều';
                
                multiCheckDiv.appendChild(check);
                multiCheckDiv.appendChild(checkLabel);
                
                item.appendChild(multiCheckDiv); 
                answerMapping.appendChild(item);
            });
            container.appendChild(answerMapping);
            
            return container;
        }

        function createListEditor(qIndex, title, items, onUpdate, onDelete, onAdd) {
            const group = document.createElement('div');
            group.className = 'list-group';
            const label = document.createElement('h4');
            label.textContent = title;
            group.appendChild(label);

            (items || []).forEach((itemText, index) => {
                const item = document.createElement('div');
                item.className = 'option-item';
                
                const inputText = document.createElement('input');
                inputText.type = 'text';
                inputText.value = itemText;
                inputText.onchange = (e) => onUpdate(qIndex, index, e.target.value);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger delete-btn';
                deleteBtn.textContent = 'X';
                deleteBtn.onclick = () => onDelete(qIndex, index);
                
                item.appendChild(inputText);
                item.appendChild(deleteBtn);
                group.appendChild(item);
            });
            
            const addBtn = document.createElement('button');
            addBtn.className = 'btn btn-add';
            addBtn.textContent = 'Thêm';
            addBtn.onclick = () => onAdd(qIndex);
            group.appendChild(addBtn);
            
            return group;
        }

        // 6. CÁC HÀM CẬP NHẬT 

        function rerenderQuestionCard(qIndex) {
            const oldCard = document.getElementById(`card-${qIndex}`);
            if (!oldCard) return; 
            
            const questionData = flatQuestionRefs[qIndex];
            if (!questionData) return; 
            
            const newCard = createQuestionCard(questionData, qIndex);
            
            oldCard.parentNode.replaceChild(newCard, oldCard);
        }
        
        function updateField(qIndex, key, value) {
            flatQuestionRefs[qIndex][key] = value;
        }
        function updateOptionText(qIndex, oIndex, value) {
            flatQuestionRefs[qIndex].options[oIndex] = value;
        }

        function updateChoiceAnswer(qIndex, oIndex) {
            const question = flatQuestionRefs[qIndex];
            const answerValue = oIndex + 1;
            
            if (question.type === 'single_choice') {
                question.answers = answerValue;
            } else {
                if (!Array.isArray(question.answers)) question.answers = [];
                const indexInAnswers = question.answers.indexOf(answerValue);
                if (indexInAnswers > -1) {
                    question.answers.splice(indexInAnswers, 1);
                } else {
                    question.answers.push(answerValue);
                }
                question.answers.sort((a, b) => a - b);
            }
            // Không cần rerender vì UI đã tự cập nhật (radio/checkbox)
        }
        
        function updateTFAnswer(qIndex, answerKey, value) {
            flatQuestionRefs[qIndex].answers[answerKey] = value;
        }

        function addOption(qIndex) { 
            if (!flatQuestionRefs[qIndex].options) flatQuestionRefs[qIndex].options = [];
            flatQuestionRefs[qIndex].options.push("Tùy chọn mới");
            rerenderQuestionCard(qIndex); 
        }

        function deleteOption(qIndex, oIndex) { 
            const question = flatQuestionRefs[qIndex];
            const deletedValue = oIndex + 1;
            question.options.splice(oIndex, 1);

            if (question.type === 'single_choice') {
                if (question.answers === deletedValue) question.answers = null;
                else if (question.answers > deletedValue) question.answers--;
            } else {
                if (!Array.isArray(question.answers)) question.answers = [];
                question.answers = question.answers
                    .filter(ans => ans !== deletedValue)
                    .map(ans => (ans > deletedValue ? ans - 1 : ans));
            }
            rerenderQuestionCard(qIndex); 
        }
        
        function addTFOption(qIndex) {
            const question = flatQuestionRefs[qIndex];
            if (!question.options) question.options = [];
            if (!question.answers) question.answers = {};
            
            question.options.push("Mệnh đề mới");
            const newKey = question.options.length.toString();
            question.answers[newKey] = "Đúng";
            rerenderQuestionCard(qIndex); 
        }
        
        function deleteTFOption(qIndex, oIndex) {
            const question = flatQuestionRefs[qIndex];
            question.options.splice(oIndex, 1);
            
            const oldAnswers = question.answers;
            const newAnswers = {};
            const oldKeys = Object.keys(oldAnswers).sort((a, b) => parseInt(a) - parseInt(b));
            
            oldKeys.forEach(oldKey => {
                const oldIndex = parseInt(oldKey) - 1;
                if (oldIndex < oIndex) {
                    newAnswers[oldKey] = oldAnswers[oldKey];
                } else if (oldIndex > oIndex) {
                    const newKey = (oldIndex).toString();
                    newAnswers[newKey] = oldAnswers[oldKey];
                }
            });

            question.answers = newAnswers;
            rerenderQuestionCard(qIndex); 
        }

        // --- Cập nhật cho Kéo Thả ---
        function updateDDOption(qIndex, oIndex, value) {
            flatQuestionRefs[qIndex].options[oIndex] = value;
            rerenderQuestionCard(qIndex); // Rerender để cập nhật tên Options trong dropdown
        }
        function deleteDDOption(qIndex, oIndex) {
            const question = flatQuestionRefs[qIndex];
            const deletedValue = oIndex + 1;
            question.options.splice(oIndex, 1);
            const answers = question.answers;
            for (const zone in answers) {
                let ans = answers[zone];
                if (Array.isArray(ans)) {
                    answers[zone] = ans
                        .filter(v => v !== deletedValue)
                        .map(v => (v > deletedValue ? v - 1 : v));
                } else {
                    if (ans === deletedValue) answers[zone] = null;
                    else if (ans > deletedValue) answers[zone]--;
                }
            }
            rerenderQuestionCard(qIndex);
        }
        function addDDOption(qIndex) {
            if (!flatQuestionRefs[qIndex].options) flatQuestionRefs[qIndex].options = [];
            flatQuestionRefs[qIndex].options.push("New Option");
            rerenderQuestionCard(qIndex);
        }
        function updateDDZone(qIndex, zIndex, value) {
            const question = flatQuestionRefs[qIndex];
            const oldZoneText = question.drop_zones[zIndex];
            if (oldZoneText !== value && value.trim() !== "") {
                const answer = question.answers[oldZoneText];
                delete question.answers[oldZoneText];
                question.answers[value] = answer;
                question.drop_zones[zIndex] = value;
                rerenderQuestionCard(qIndex);
            }
        }
        function deleteDDZone(qIndex, zIndex) {
            const question = flatQuestionRefs[qIndex];
            const zoneText = question.drop_zones.splice(zIndex, 1)[0];
            delete question.answers[zoneText];
            rerenderQuestionCard(qIndex);
        }
        function addDDZone(qIndex) {
            const question = flatQuestionRefs[qIndex];
            if (!question.drop_zones) question.drop_zones = [];
            if (!question.answers) question.answers = {};
            const newZone = `Vùng thả mới ${question.drop_zones.length + 1}`;
            question.drop_zones.push(newZone);
            question.answers[newZone] = null;
            rerenderQuestionCard(qIndex);
        }
        function updateDDAnswer(qIndex, zoneText, selectedValue) {
            flatQuestionRefs[qIndex].answers[zoneText] = selectedValue;
        }
        
        function toggleDDMulti(qIndex, zoneText, isChecked) {
            const question = flatQuestionRefs[qIndex];
            const currentAnswer = question.answers[zoneText];

            if (isChecked) { 
                if (!Array.isArray(currentAnswer)) {
                    question.answers[zoneText] = (currentAnswer === null || currentAnswer === undefined) ? [] : [currentAnswer];
                }
            } else { 
                if (Array.isArray(currentAnswer)) {
                    question.answers[zoneText] = (currentAnswer.length > 0) ? currentAnswer[0] : null;
                }
            }
            rerenderQuestionCard(qIndex); // Rerender để chuyển đổi từ Custom Multi-select sang Single Select Dropdown (và ngược lại)
        }
        
        // 7. HÀM CHUYỂN ĐỔI TYPE
        function changeQuestionType(qIndex, newType) {
            const question = flatQuestionRefs[qIndex];
            if (question.type === newType) return;

            question.type = newType;

            // Xóa các trường không liên quan
            if (newType !== 'drag_drop') delete question.drop_zones;
            
            // Đảm bảo các trường cơ bản tồn tại
            if (['single_choice', 'multiple_choice', 'true_false', 'drag_drop'].includes(newType)) {
                if (!question.options) question.options = [];
            }
            if (newType === 'drag_drop') {
                if (!question.drop_zones) question.drop_zones = [];
            }

            // Reset Answers dựa trên Type mới
            switch (newType) {
                case 'single_choice':
                    question.answers = null;
                    break;
                case 'multiple_choice':
                    question.answers = [];
                    break;
                case 'fill_blank':
                    question.answers = "";
                    break;
                case 'true_false':
                    const tfAnswers = {};
                    (question.options || []).forEach((o, i) => {
                        tfAnswers[(i + 1).toString()] = "Đúng";
                    });
                    question.answers = tfAnswers;
                    break;
                case 'drag_drop':
                    const ddAnswers = {};
                    (question.drop_zones || []).forEach(zone => {
                        ddAnswers[zone] = null;
                    });
                    question.answers = ddAnswers;
                    break;
            }
            rerenderQuestionCard(qIndex); 
        }
        
        // 8. HÀM THÊM CÂU HỎI MỚI
        function addNewQuestion(subjectIndex) {
            const newId = `new-${Date.now()}`;
            const newQuestion = {
                id: newId,
                text: "Nội dung câu hỏi mới...",
                type: "single_choice",
                options: ["Lựa chọn 1", "Lựa chọn 2"],
                answers: 1
            };

            // 1. Thêm vào dữ liệu gốc (originalData)
            let questionsArray = [];
            if (originalData.subjects && Array.isArray(originalData.subjects)) {
                questionsArray = originalData.subjects[subjectIndex].questions;
            } else if (originalData.questions && Array.isArray(originalData.questions)) {
                questionsArray = originalData.questions;
            } else if (Array.isArray(originalData)) {
                questionsArray = originalData;
            }
            
            questionsArray.push(newQuestion);

            // 2. Thêm vào mảng tham chiếu phẳng (flatQuestionRefs)
            const newQIndex = flatQuestionRefs.length;
            flatQuestionRefs.push(newQuestion);

            // 3. Thêm card mới vào DOM
            const newCard = createQuestionCard(newQuestion, newQIndex);
            
            const paneId = `pane-${subjectIndex}`;
            const pane = document.getElementById(paneId);
            if (pane) {
                const addButton = pane.querySelector('.btn-primary'); 
                if (addButton) {
                    pane.insertBefore(newCard, addButton);
                    newCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }

    </script>
</body>
</html>
